
-- Create a calendar/date dimension table
CREATE TABLE dbo.DimCalendar
(
    DateKey        INT         NOT NULL PRIMARY KEY,  -- YYYYMMDD
    FullDate       DATE        NOT NULL,              -- Actual date
    DateTxt        VARCHAR(9)  NOT NULL,              --YYYY-MM-DD
    DayNumber      TINYINT     NOT NULL,              -- 1-31
    DayName        VARCHAR(10) NOT NULL,              -- Monday, Tuesday...
    DayOfWeek      TINYINT     NOT NULL,              -- 1 = Monday, 7 = Sunday
    WeekOfYear     TINYINT     NOT NULL,              -- 1-52
    MonthNumber    TINYINT     NOT NULL,              -- 1-12
    MonthName      VARCHAR(10) NOT NULL,              -- January...
    MonthStart     DATE        NOT NULL,              -- First date of the month
    MonthEnd       DATE        NOT NULL,             -- Last date of the month
    QuarterNumber  TINYINT     NOT NULL,              -- 1-4
    Quarter        VARCHAR(2)  NOT NULL,              -- Q1-Q4
    YearNumber     INT         NOT NULL,              -- 2025, etc.
    IsWeekend      BIT         NOT NULL
);
GO

------------------------------------------------------------------------------------------------------------

DECLARE @startdate as DATE;
DECLARE @enddate as DATE;
--Set start date as first of month 12 months ago
SET @startdate = DATEFROMPARTS(YEAR(DATEADD(YY, -7, GETDATE())), 1 , 1);
--Set end date as last of month 1 months ago
SET @enddate = DATEFROMPARTS(YEAR(DATEADD(YY, 1, GETDATE())), 12 , 31);

-- Populate with a date range (e.g., 2000-01-01 through 2030-12-31)
;WITH DateRange AS
(
    SELECT CAST(@startdate AS DATE) AS TheDate
    UNION ALL
    SELECT DATEADD(DAY, 1, TheDate)
    FROM DateRange
    WHERE TheDate < @end
)
INSERT INTO dbo.DimCalendar
(
    DateKey, FullDate, DateTxt, DayNumber, DayName, DayOfWeek, 
    WeekOfYear, MonthNumber, MonthName, MonthStart, MonthEnd, QuarterNumber, Quarter, YearNumber, IsWeekend
)
SELECT
    CONVERT(INT, FORMAT(TheDate, 'yyyyMMdd')) AS DateKey,
    TheDate,
    CONVERT(STR, FORMAT(TheDate, 'yyyy-MM-dd') AS DateTxt,
    DAY(TheDate) AS DayNumber,
    DATENAME(WEEKDAY, TheDate) AS DayName,
    DATEPART(WEEKDAY, TheDate) AS DayOfWeek,
    DATEPART(WEEK, TheDate) AS WeekOfYear,
    MONTH(TheDate) AS MonthNumber,
    DATENAME(MONTH, TheDate) AS MonthName,
    DATEFROMPARTS(YEAR(TheDate),MONTH(TheDate),1) AS MonthStart;
    EOM(TheDate) AS MonthEnd;
    DATEPART(QUARTER, TheDate) AS QuarterNumber,
    CONCAT('Q',DATEPART(QUARTER, TheDate)) AS Quarter,
    YEAR(TheDate) AS YearNumber,
    CASE WHEN DATENAME(WEEKDAY, TheDate) IN ('Saturday','Sunday') THEN 1 ELSE 0 END AS IsWeekend
FROM DateRange
OPTION (MAXRECURSION 32767);
GO
